<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <style>
    	#container {
    		width: 100%;
    		height: 450px;
    	}
    </style>
</head>

<body>
	<label>X-axis</label>
	<select onchange="selectionChangeX(this.value)">
		<option value = "0">By School</option>
	</select>
	<button onclick="clickInc()" style="margin-left: 96px">Next 30</button>
	<br><br>
	<label>Y-axis</label>
	<select onchange="selectionChangeY(this.value)">
		<option value = "0">Early Career Pay</option>
		<option value = "1">Mid Career Pay</option>
		<option value = "2">Make World Better%</option>
		<option value = "3">Stem Enrollment%</option>
		<option value = "4">Early to Mid %inc</option>
		<option value = "5">Salary Pot. Rank For State</option>
	</select>
	<button onclick="clickDec()">Prev. 30</button>
	<button onclick="sortObjects()">Sort!</button>
	<script>

		// This needs to be broken up into different files, but it's fine for now.

		const collegeData = [];
		const properties = {
			0: 'early_career_pay',
			1: 'mid_career_pay',
			2: 'make_world_better_percent',
			3: 'stem_percent',
			4: 'early_to_mid_percent_increase',
			5: 'rank_salary_potential_state'
		};
		let selectedXElement = 0;	// Value of X-axis selection
		let selectedYElement = 0;	// Value of Y-axis selection
		let displayNum = 0;			// Draw items to graph starting from this to (this + 30)

		d3.csv("/salary.csv", (items) => {
			for (let i = 0; i < items.length; i++) {
				collegeData[i] = items[i];
			}
			update();
		});

		function selectionChangeX(changedTo) {
			selectedXElement = Number(changedTo);
			displayNum = 0;
			update()
		}

		function selectionChangeY(changedTo) {
			selectedYElement = Number(changedTo);
			update()
		}

		function clickInc() {
			if (displayNum + 30 >= collegeData.length) return;
			displayNum += 30;
			update();
		}

		function clickDec() {
			if (displayNum === 0) return;
			displayNum -= 30;
			update();
		}

		function sortObjects() {
			collegeData.sort((x, y) => {
					return x[properties[selectedYElement]] - 
							y[properties[selectedYElement]]
				});
			if (selectedYElement !== 5) 
				collegeData.reverse(); // for 'Salary Pot. Rank' smaller is greater/better
			update();
		}

		const hoverText = d3.select("body")
			.append("div")
			.style("top", "445px")
			.style("position", "absolute")
			.style("visibility", "hidden");

		function update() {
			const box = d3.select("body").select("svg");
			box.selectAll("*").remove();

			for (let i = displayNum; i < displayNum + 30 && i < collegeData.length; i++) {

				const item = collegeData[i]
				const itemXPos = (i - displayNum) * 30 + 50;
				const itemHeight = getBarHeight(item[properties[selectedYElement]]);
				const itemYPos = 230 - itemHeight;

				// Draw the elements/bars inside the graph
				box.insert("rect")
					.attr("y", itemYPos + "px")
					.attr("x", itemXPos + "px")
					.attr("fill", "green")
					.style("width", 20 + "px")
					.style("height", itemHeight + "px")
					.on("mouseover", function() {
						d3.select(this).attr("fill", "red");
						d3.select("body").select("svg").append("text")
							.attr("y", itemYPos - 10 + "px")
							.attr("x", itemXPos + 10 + "px")
							.attr("text-anchor", "middle")
							.attr("fill", "red")
							.attr("id", "value")
							.text(item[properties[selectedYElement]]);
					})
					.on("mouseout", function() {
						d3.select(this).attr("fill", "green");
						box.selectAll("#value").remove();
					});

				// Draw item names along x-axis
				box.insert("text")
					.attr("x", itemXPos + 5 + "px")
					.attr("y", 235 + "px")
					.attr("transform", "rotate(90," + (itemXPos + 5) + ",235)")
					.text(() => {
						if (item.name.length > 15)
							return item.name.slice(0,15) + "..."
						return item.name;
					}).on("mouseover", function() {
						return hoverText.style("visibility", "visible").style("left", itemXPos - 20 + "px").text(item.name);
					}).on("mouseout", function() {
						return hoverText.style("visibility", "hidden");
					});
			}
			// Draw X axis
			box.insert("line")
				.attr("x1", 35 + "px")
				.attr("y1", 230 + "px")
				.attr("x2", 35 + "px")
				.attr("y2", 30 + "px")
				.attr("stroke", "black")
			// Draw range values (0 - bottom, 1 = middle, 2 - top)
			const insertText = (n, str) => box.insert("text")
										.attr("x", 32 + "px")
										.attr("y", 230 - 100 * n + "px")
										.attr("text-anchor", "end")
										.text(str);
			switch (selectedYElement) {
				case 0: 	// Early range 30k-100k
					insertText(0, "30k");
					insertText(1, "65k");
					insertText(2, "100k");
					break;
				case 1: 	// Mid range 60k - 160k
					insertText(0, "60k");
					insertText(1, "110k");
					insertText(2, "160k");
					break;
				case 2: 	// MWB% range 0 - 100
					insertText(0, "0");
					insertText(1, "50");
					insertText(2, "100");
					break;
				case 3: 	// Stem% range 0 - 100
					insertText(0, "0");
					insertText(1, "50");
					insertText(2, "100");
					break;
				case 4: 	// %inc range .6 - 1.1
					insertText(0, ".6");
					insertText(1, ".85");
					insertText(2, "1.1");
					break;
				case 5: 	// Rank range 25 - 1
					insertText(0, "25");
					insertText(1, "12");
					insertText(2, "1");
					break;
			}
		}

		function getBarHeight(value) {
			let scaledValue;
			switch (selectedYElement) {
				case 0: 	// Early range 30k-100k
					scaledValue = (value - 30000) / 70000 * 200;
					break;
				case 1: 	// Mid range 60k - 160k
					scaledValue = (value - 60000) / 100000 * 200;
					break;
				case 2: 	// MWB% range 0 - 100
					scaledValue =  value * 2;
					break;
				case 3: 	// Stem% range 0 - 100
					scaledValue = value * 2;
					break;
				case 4: 	// %inc range .6 - 1.1
					scaledValue = (value - .6) / .5 * 200;
					break;
				case 5: 	// Rank range 25 - 1
					scaledValue = (25 - value) * 8 + 8;
					break;
			}
			return scaledValue;
		}
	</script>
	<svg id="container"></svg>
	<button onclick="update()">Redraw Graph</button>
</body>

</html>